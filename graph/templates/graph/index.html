{% extends "omero_graph/base.html" %}
{% load i18n %}

{% block link %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.body.css" %}"/>
    <link rel="stylesheet" href="{% static "webgateway/css/ome.table.css"|add:url_suffix %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% static "3rdparty/jquery.tablesorter-2.0.3/jquery.tablesorter.css" %}" type="text/css" media="screen"/>
	<link rel="stylesheet" href="{% static '3rdparty/jquery.chosen-1.2.0/chosen.css' %}" type="text/css" media="screen"/>
{% endblock %}

{% block script %}
	{{ block.super }}
	<script type="text/javascript" src="{% static '3rdparty/jquery.chosen-1.2.0/chosen.jquery.js' %}"></script>
	<script type="text/javascript">
	$(document).ready(function() {
		$("#id_annotation").chosen({disable_search_threshold: 10,placeholder_text:'Choose annotation to plot'});
		$("#id_x").chosen({disable_search_threshold: 10,placeholder_text:'Choose data for x axis',width: "300px"});
		$("#id_y").chosen({disable_search_threshold: 10,placeholder_text:'Choose columns to plot',width: "300px"});
		
		$("#setup_container").hide();
		$("#plot_container").hide();
		
		//global annotation id
		var annId = 0;
		
		var ann_frm = $('#annotation_form');
		ann_frm.submit(function(event) {
			event.preventDefault();
			var annotation = $('#id_annotation').val();
			var header = $('#id_header').val();
			console.log(annotation)
			$.ajax({
				traditional: true,
				type: "POST",
				url: ann_frm.attr('action'),
				data : {'annotation' : annotation, 'header': header},
				success: function(results) {
					var xoptions = $("#id_x");
					var yoptions = $("#id_y");
					var columns = results.columns;
					$("#id_x").empty();
					$("#id_y").empty();
					xoptions.append($("<option />").val("").text(""));
					for (i = 1; i < columns.length; i++) {
						xoptions.append($("<option />").val(columns[i][0]).text(columns[i][1]));
					}
					for (i = 0; i < columns.length; i++) {
						yoptions.append($("<option />").val(columns[i][0]).text(columns[i][1]));
					}
					$("#id_x").trigger("chosen:updated");
					$("#id_y").trigger("chosen:updated");
					$("#setup_container").show();
			  },
			  error: function(error) {
			    console.log(error)
			  }
			});
		});
		var plot_frm = $('#plotform');
		plot_frm.submit(function(event) {
			event.preventDefault();
			var x = $('#id_x').val();
			var y = $('#id_y').val();
			var annId = "{{ request.session.annotation_id }}";
			console.log("the form has beeen submitted");
			console.log("x:",x,"y:",y)
			$.ajax({
				traditional: true,
				type: "POST",
				url: "/omero_graph/plot/",
				data : {'x' : x, 'y': y},
				success: function(plotresults) {
					console.log(plotresults)
					series = generateData(plotresults.ydata);

					function generateData(seriesdata) {
					    series = [];
					    for (i = 0; i < seriesdata.length; i++) {
					        var d = seriesdata[i];
				            series.push({
								name: 'Series'+String(i),
				                data: d
				            });
					    }
						console.log(series)
					    return series;
					}
					$('#id_annotation').val('').trigger('liszt:updated');
					$('#plot_container').show();
				    $('#plot_container').highcharts({
				        chart: {
				            type: 'line'
				        },
				        title: {
				            text: plotresults.title
				        },
				        xAxis: {
							allowDecimals: false,
							title: {text: x},
				            tickInterval: 10,
							categories: plotresults.xdata
				        },
				        yAxis: {
				            title: {
				                text: y
				            }
				        },
				        series: series
				    });
			  },
			  error: function(error) {
			    console.log(error)
			  }
			});
		});
	});
	</script>
{% endblock%}

{% block title %}
    Graphs
{% endblock %}

{% block center_details %}
{{ block.super }}

<div class="one_column_content">
	<h1>Annotations for {{ userFullName }}</h1>
	{% if annotations %}
		<p>You have a total of {{ num_annotations }} annotations elligible for plotting.<p>
		<p>There are {{ num_xls }} Excel files, {{ num_csv }} CSV files and {{ num_txt }} TXT files</p>
		<p>Select an annotation from the list and state which row holds the column names.
			Leave blank if there are no column names.</p>

		<form class="standard_form settings_form" action="{% url 'find' %}" method="POST" id="annotation_form">{% csrf_token %}
			{{ form.as_p }}
			<input value="Submit" type="submit" />
		</form>

	{% else %}
	    <p>No annotations.</p>
	{% endif %}
	<div id="setup_container">
		<form class="standard_form settings_form" action="" method="POST" id="plotform">{% csrf_token %}
		    {{graph_form.as_p}}
		    <input value="Plot" type="submit" />
		</form>
	</div>
</div>
<div id="plot_container" style="width:100%; height:400px;"></div>
{% endblock %}