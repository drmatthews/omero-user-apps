{% extends "graph/base.html" %}
{% load i18n %}

{% block title %}
    Graphs
{% endblock %}

{% block center_details %}
	{{ block.super }}

	<div class="one_column_content">
		<h1>Annotations for {{ userFullName }}</h1>
		{% if annotations %}
			<p>You have a total of {{ num_annotations }} annotations.<p>
			<p>There are {{ num_xls }} Excel files, {{ num_csv }} CSV files and {{ num_txt }} TXT files</p>
			<p>Select an annotation from the list and state which row holds the column names.
				Leave 'Header' blank if there are no column names.</p>

			<form class="standard_form settings_form" action="{% url 'preview' %}" method="POST" id="preview_form">{% csrf_token %}
				{{ prev_form.annotation.errors }}
				{% for field in prev_form %}
					{% ifequal field.label_tag prev_form.preview_sheet.label_tag %}
						<p id="preview_sheet">{{ field.label_tag }}
						   {{ field }}</p>
					{% else %}
						<p>{{ field.label_tag }}
						   {{ field }}</p>
					{% endifequal %}
				{% endfor %}
				<input value="Preview" type="submit" />
			</form>
			<div id="preview_data"></div>
			<form class="standard_form settings_form" action="{% url 'find' %}" method="POST" id="annotation_form">{% csrf_token %}
				{{ form.annotation.errors }}
				{% for field in form %}
					{% ifequal field.label_tag form.sheet.label_tag %}
						<p id="sheet">{{ field.label_tag }}
						   {{ field }}</p>
					{% else %}
						<p>{{ field.label_tag }}
						   {{ field }}</p>
					{% endifequal %}
				{% endfor %}
				<input value="Get Columns" type="submit" />
			</form>
			<div id="graph_setup">Pre-populated form will go here...</div>
		{% else %}
		    <p>No annotations.</p>
		{% endif %}

	</div>
	<div id="graph_container">Loading...</div>
{% endblock %}

{% block body %}
	{{ block.super }}
	
	<script src="{% static 'graph/js/jquery.flot.js' %}"></script>
	<script src="{% static 'graph/js/jquery.flot.axislabels.js' %}"></script>
	<script src="{% static 'graph/js/underscore.js' %}"></script>
	<script src="{% static 'graph/js/backbone.js' %}"></script>
	<script src="{% static 'graph/js/html2canvas.js' %}"></script>
	<script type="text/javascript" src="{% static '3rdparty/jquery.chosen-1.2.0/chosen.jquery.js' %}"></script>
	
	<script type="text/javascript">
		$(document).ready(function() {
			$("#id_preview_annotation").chosen({disable_search_threshold: 10,placeholder_text:'Choose annotation to preview'});
			$("#id_annotation").chosen({disable_search_threshold: 10,placeholder_text:'Choose annotation to plot'});
			$("#id_x").chosen({disable_search_threshold: 10,placeholder_text:'Choose data for x axis',width: "300px"});
			$("#id_y").chosen({disable_search_threshold: 10,placeholder_text:'Choose columns to plot',width: "300px"});
			$("#preview_sheet").hide();
			$("#sheet").hide();
			$("#setup_container").hide();
			
			if ($('#id_annotation').val().indexOf('xls')>0) {
						$("#preview_sheet").show();
						$("#sheet").show();
					};
			$('#id_preview_annotation').on('change',function() {
				var prev_annotation = $('#id_preview_annotation').val();
				if (prev_annotation.indexOf('xls')>0) {
					$("#preview_sheet").show();
				}
				else {
					$("#preview_sheet").hide();
				}
			});
			$('#id_annotation').on('change',function() {
				var annotation = $('#id_annotation').val();
				if (annotation.indexOf('xls')>0) {
					$("#sheet").show();
				}
				else {
					$("#sheet").hide();
				}
			});
		});
	</script>

   <script type="text/template" id="graphform-template">
		<form class="standard_form settings_form" action="" method="POST" id="graphform">{% csrf_token %}
			{{graph_form.as_p}}
			<input value="Plot" type="submit" />
		</form>
    </script>
			
   <script type="text/template" id="graph-template">
      <div id="graph_placeholder"></div>
    </script>
	
	<script type="text/javascript">
		
	    var app = {}; // create namespace for our app

	    app.Graph = Backbone.Model.extend({
	      defaults: {
	        title: '',
			xaxis_title: '',
			yaxis_title: '',
			url: '/graph/plot' 
	      }
	    });


		var GraphView = Backbone.View.extend({
		  el: $('#graph_container'),
		  // template which has the placeholder 'who' to be substitute later
		  template: _.template($('#graph-template').html()),
		  initialize: function(){
		    this.render();
		  },
		  render: function(){
		    // render the function using substituting the varible 'who' for 'world!'.
		    this.$el.html(this.template({who: 'here!'}));
		    //***Try putting your name instead of world.
		  }
		});

		var appView = new GraphView();

	</script>
{% endblock %}
